def update_yaml_with_namespaces(yaml_file_path, namespaces):
    logger.info(f"Updating YAML file with namespaces (no regex): {yaml_file_path}")
    try:
        with open(yaml_file_path, 'r') as file:
            data = yaml.safe_load(file)

        def recursive_update(d):
            for key, value in d.items():
                if isinstance(value, dict):
                    recursive_update(value)
                elif isinstance(value, str) and ".svc.cluster.local" in value:
                    parts = value.split("://")
                    if len(parts) != 2:
                        continue
                    scheme, rest = parts
                    # Example: rest = 'dsapi-srfeaccess.digital-servicing-{SHIELD_ENV}-01.svc.cluster.local:8080/...'
                    segments = rest.split('.svc.cluster.local')
                    if len(segments) < 2:
                        continue

                    host = segments[0]  # 'dsapi-srfeaccess.digital-servicing-{SHIELD_ENV}-01'
                    path_and_port = segments[1]  # ':8080/...'

                    # Split host into appname + namespace
                    host_parts = host.split('.')
                    if len(host_parts) < 2:
                        continue  # skip if it doesnâ€™t have appname.namespace structure

                    appname = host_parts[0]
                    old_namespace = '.'.join(host_parts[1:])

                    if appname in namespaces and namespaces[appname]:
                        new_namespace = namespaces[appname][0]
                        new_url = f"{scheme}://{appname}.{new_namespace}.svc.cluster.local{path_and_port}"
                        logger.info(f"Updating URL for app '{appname}': '{value}' -> '{new_url}'")
                        d[key] = new_url

        recursive_update(data)

        with open(yaml_file_path, 'w') as file:
            yaml.safe_dump(data, file)

        logger.info("YAML file updated successfully.")
    except Exception as e:
        logger.error(f"Error updating YAML file: {e}")
        raise


def update_yaml_with_namespaces(yaml_file_path, namespaces):
    logger.info(f"Updating YAML file with namespaces: {yaml_file_path}")
    try:
        with open(yaml_file_path, 'r') as file:
            data = yaml.safe_load(file)

        # Pattern to capture and replace the full namespace
        # Matches: http://<appname>.<namespace>.svc.cluster.local
        full_pattern = re.compile(
            r'(http://[a-zA-Z0-9\-]+)\.([a-zA-Z0-9\-\{\}_\)\(]+)\.svc\.cluster\.local')

        def recursive_update(d):
            for key, value in d.items():
                if isinstance(value, dict):
                    recursive_update(value)
                elif isinstance(value, str):
                    match = full_pattern.search(value)
                    if match:
                        appname = match.group(1).split('//')[-1]  # Remove http://
                        old_ns = match.group(2)

                        # Find matching real namespace from the map
                        for ns_key, ns_values in namespaces.items():
                            if ns_values:
                                real_ns = ns_values[0]
                                new_url = value.replace(old_ns, real_ns)
                                logger.info(f"Replacing '{old_ns}' with '{real_ns}' in URL '{value}'")
                                d[key] = new_url
                                break

        recursive_update(data)

        with open(yaml_file_path, 'w') as file:
            yaml.safe_dump(data, file)

        logger.info("YAML file updated successfully.")
    except Exception as e:
        logger.error(f"Error updating YAML file: {e}")
        raise

